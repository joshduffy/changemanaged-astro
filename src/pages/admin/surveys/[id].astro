---
import AdminLayout from "../../../components/admin/AdminLayout.astro";

const apiUrl = import.meta.env.SURVEY_API_URL || "https://survey.changemanaged.io";
const apiKey = import.meta.env.SURVEY_ADMIN_API_KEY;

const { id } = Astro.params;

interface Question {
  id: number;
  section_name: string | null;
  section_order: number;
  question_order: number;
  question_type: string;
  question_text: string;
  help_text: string | null;
  required: boolean;
  options: string | null;
}

interface Survey {
  id: number;
  name: string;
  description: string | null;
  status: "draft" | "active" | "archived";
  created_at: string;
  updated_at: string;
  questions: Question[];
}

let survey: Survey | null = null;
let error: string | null = null;

try {
  const response = await fetch(`${apiUrl}/api/surveys/${id}`, {
    headers: { Authorization: `Bearer ${apiKey}` },
  });

  if (response.ok) {
    const data = await response.json();
    survey = data.survey;
  } else if (response.status === 404) {
    error = "Survey not found";
  } else {
    error = "Failed to load survey";
  }
} catch {
  error = "Failed to connect to API";
}

function getStatusStyle(status: string): { label: string; class: string } {
  switch (status) {
    case "active":
      return { label: "Active", class: "bg-green-100 text-green-700" };
    case "archived":
      return { label: "Archived", class: "bg-gray-100 text-gray-600" };
    default:
      return { label: "Draft", class: "bg-yellow-100 text-yellow-700" };
  }
}

export const prerender = false;
---

<AdminLayout title={survey ? `Edit: ${survey.name}` : "Survey Not Found"} currentPage="surveys">
  {error ? (
    <div class="bg-red-50 rounded-xl border border-red-200 p-6">
      <h2 class="text-lg font-medium text-red-800">{error}</h2>
      <a href="/admin/surveys" class="text-red-600 underline mt-2 inline-block">Back to surveys</a>
    </div>
  ) : survey && (
    <div class="max-w-4xl">
      <!-- Back Link -->
      <a href="/admin/surveys" class="inline-flex items-center gap-2 text-graphite hover:text-charcoal mb-6">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Surveys
      </a>

      <!-- Survey Header -->
      <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-charcoal">Survey Details</h2>
            <span class={`text-xs px-2 py-1 rounded-full ${getStatusStyle(survey.status).class}`}>
              {getStatusStyle(survey.status).label}
            </span>
          </div>
          <div class="flex items-center gap-2">
            {survey.status === "draft" && (
              <button
                id="publish-btn"
                class="inline-flex items-center gap-2 bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors text-sm"
              >
                Publish
              </button>
            )}
            {survey.status === "active" && (
              <a
                href={`/admin/surveys/${survey.id}/tokens`}
                class="inline-flex items-center gap-2 bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors text-sm"
              >
                Manage Tokens
              </a>
            )}
            {survey.status !== "archived" && (
              <button
                id="archive-btn"
                class="text-graphite hover:text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors text-sm"
              >
                Archive
              </button>
            )}
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label for="survey-name" class="block text-sm font-medium text-charcoal mb-2">Name</label>
            <input
              type="text"
              id="survey-name"
              value={survey.name}
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent font-medium"
            />
          </div>
          <div>
            <label for="survey-description" class="block text-sm font-medium text-charcoal mb-2">Description</label>
            <textarea
              id="survey-description"
              rows="2"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
            >{survey.description || ""}</textarea>
          </div>
        </div>

        <div class="flex items-center justify-between mt-4 pt-4 border-t border-stone/20">
          <span class="text-sm text-graphite">
            {survey.questions.length} questions
          </span>
          <button
            id="save-details-btn"
            class="text-deep-sage hover:text-muted-sage text-sm font-medium"
          >
            Save Changes
          </button>
        </div>
      </div>

      <!-- Questions Section -->
      <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-charcoal">Questions</h3>
          <button
            id="add-question-btn"
            class="inline-flex items-center gap-2 text-deep-sage hover:text-muted-sage text-sm font-medium"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Add Question
          </button>
        </div>

        <div id="questions-container" class="space-y-3">
          {survey.questions.length === 0 ? (
            <p class="text-graphite text-center py-8">No questions yet. Add your first question above.</p>
          ) : (
            survey.questions.map((q, index) => {
              const opts = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];
              return (
                <div class="question-card bg-linen rounded-lg p-4 border border-stone/20" data-id={q.id} data-index={index}>
                  <div class="flex items-start gap-4">
                    <div class="drag-handle cursor-grab text-stone hover:text-graphite mt-1">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16" />
                      </svg>
                    </div>

                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium text-deep-sage">Q{index + 1}</span>
                        <span class="text-xs bg-white text-graphite px-2 py-0.5 rounded border border-stone/20">{q.question_type}</span>
                        {q.required && <span class="text-xs text-red-500">Required</span>}
                      </div>
                      <p class="text-charcoal">{q.question_text}</p>
                      {q.help_text && <p class="text-sm text-graphite mt-1">{q.help_text}</p>}
                      {opts.length > 0 && (
                        <div class="mt-2 flex flex-wrap gap-1">
                          {opts.map((o: string) => (
                            <span class="text-xs bg-white text-graphite px-2 py-1 rounded border border-stone/20">{o}</span>
                          ))}
                        </div>
                      )}
                    </div>

                    <div class="flex items-center gap-1">
                      <button class="edit-question-btn text-graphite hover:text-deep-sage p-1" data-id={q.id} title="Edit">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      <button class="delete-question-btn text-graphite hover:text-red-500 p-1" data-id={q.id} title="Delete">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="bg-red-50 rounded-xl border border-red-200 p-6">
        <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
        <p class="text-sm text-red-600 mb-4">Permanently delete this survey and all its responses. This action cannot be undone.</p>
        <button
          id="delete-btn"
          class="text-red-600 hover:text-red-800 text-sm font-medium underline"
        >
          Delete Survey
        </button>
      </div>
    </div>
  )}

  <!-- Question Edit Modal -->
  <div id="question-modal" class="fixed inset-0 bg-charcoal/50 hidden items-center justify-center z-50">
    <div class="bg-cream rounded-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <h3 id="modal-title" class="text-lg font-semibold text-charcoal mb-4">Edit Question</h3>

      <form id="question-form" class="space-y-4">
        <input type="hidden" id="question-id" />

        <div>
          <label for="question-text" class="block text-sm font-medium text-charcoal mb-2">Question Text</label>
          <textarea
            id="question-text"
            rows="2"
            required
            class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="question-type" class="block text-sm font-medium text-charcoal mb-2">Type</label>
            <select
              id="question-type"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
            >
              <option value="text">Text (short)</option>
              <option value="textarea">Text (long)</option>
              <option value="radio">Single Choice</option>
              <option value="checkbox">Multiple Choice</option>
              <option value="scale">Scale (1-5)</option>
              <option value="dropdown">Dropdown</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-charcoal mb-2">Required</label>
            <label class="flex items-center gap-2 mt-2">
              <input type="checkbox" id="question-required" class="rounded border-stone/30 text-deep-sage focus:ring-deep-sage" />
              <span class="text-sm text-graphite">Mark as required</span>
            </label>
          </div>
        </div>

        <div>
          <label for="question-help" class="block text-sm font-medium text-charcoal mb-2">Help Text (optional)</label>
          <input
            type="text"
            id="question-help"
            class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
            placeholder="Additional context for respondents"
          />
        </div>

        <div id="options-container" class="hidden">
          <label class="block text-sm font-medium text-charcoal mb-2">Options (one per line)</label>
          <textarea
            id="question-options"
            rows="4"
            class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none font-mono text-sm"
            placeholder="Option 1&#10;Option 2&#10;Option 3"
          ></textarea>
        </div>

        <div class="flex items-center justify-end gap-3 pt-4 border-t border-stone/20">
          <button
            type="button"
            id="cancel-modal-btn"
            class="px-4 py-2 text-graphite hover:text-charcoal"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors"
          >
            Save Question
          </button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline define:vars={{ apiUrl, apiKey, surveyId: id, initialQuestions: survey?.questions || [] }}>
    let questions = [...initialQuestions];

    const modal = document.getElementById('question-modal');
    const modalTitle = document.getElementById('modal-title');
    const questionForm = document.getElementById('question-form');
    const questionIdInput = document.getElementById('question-id');
    const questionTextInput = document.getElementById('question-text');
    const questionTypeSelect = document.getElementById('question-type');
    const questionRequiredCheckbox = document.getElementById('question-required');
    const questionHelpInput = document.getElementById('question-help');
    const optionsContainer = document.getElementById('options-container');
    const questionOptionsTextarea = document.getElementById('question-options');

    // Show/hide options based on type
    questionTypeSelect?.addEventListener('change', () => {
      const needsOptions = ['radio', 'checkbox', 'dropdown', 'scale'].includes(questionTypeSelect.value);
      optionsContainer.classList.toggle('hidden', !needsOptions);
    });

    // Open modal for new question
    document.getElementById('add-question-btn')?.addEventListener('click', () => {
      modalTitle.textContent = 'Add Question';
      questionIdInput.value = '';
      questionTextInput.value = '';
      questionTypeSelect.value = 'text';
      questionRequiredCheckbox.checked = false;
      questionHelpInput.value = '';
      questionOptionsTextarea.value = '';
      optionsContainer.classList.add('hidden');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    // Open modal for edit
    document.querySelectorAll('.edit-question-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const q = questions.find(q => q.id == id);
        if (!q) return;

        modalTitle.textContent = 'Edit Question';
        questionIdInput.value = q.id;
        questionTextInput.value = q.question_text;
        questionTypeSelect.value = q.question_type;
        questionRequiredCheckbox.checked = q.required;
        questionHelpInput.value = q.help_text || '';

        const opts = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];
        questionOptionsTextarea.value = opts.join('\n');

        const needsOptions = ['radio', 'checkbox', 'dropdown', 'scale'].includes(q.question_type);
        optionsContainer.classList.toggle('hidden', !needsOptions);

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      });
    });

    // Close modal
    document.getElementById('cancel-modal-btn')?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });

    // Save question
    questionForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const questionData = {
        question_text: questionTextInput.value,
        question_type: questionTypeSelect.value,
        required: questionRequiredCheckbox.checked,
        help_text: questionHelpInput.value || null,
        options: ['radio', 'checkbox', 'dropdown', 'scale'].includes(questionTypeSelect.value)
          ? questionOptionsTextarea.value.split('\n').filter(o => o.trim())
          : null,
      };

      try {
        // Add or update question via API
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}/questions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ questions: [questionData] }),
        });

        if (!response.ok) throw new Error('Failed to save question');

        // Reload page to show updated questions
        window.location.reload();
      } catch (error) {
        alert('Failed to save question: ' + error.message);
      }
    });

    // Delete question
    document.querySelectorAll('.delete-question-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this question?')) return;

        const id = btn.dataset.id;
        try {
          const response = await fetch(`${apiUrl}/api/surveys/${surveyId}/questions?questionId=${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${apiKey}` },
          });

          if (!response.ok) throw new Error('Failed to delete');
          window.location.reload();
        } catch (error) {
          alert('Failed to delete question');
        }
      });
    });

    // Save survey details
    document.getElementById('save-details-btn')?.addEventListener('click', async () => {
      const name = document.getElementById('survey-name').value;
      const description = document.getElementById('survey-description').value;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ name, description }),
        });

        if (!response.ok) throw new Error('Failed to save');
        alert('Saved!');
      } catch (error) {
        alert('Failed to save: ' + error.message);
      }
    });

    // Publish
    document.getElementById('publish-btn')?.addEventListener('click', async () => {
      if (!confirm('Publish this survey? It will become available to respondents.')) return;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ status: 'active' }),
        });

        if (!response.ok) throw new Error('Failed to publish');
        window.location.reload();
      } catch (error) {
        alert('Failed to publish: ' + error.message);
      }
    });

    // Archive
    document.getElementById('archive-btn')?.addEventListener('click', async () => {
      if (!confirm('Archive this survey? It will no longer accept responses.')) return;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ status: 'archived' }),
        });

        if (!response.ok) throw new Error('Failed to archive');
        window.location.reload();
      } catch (error) {
        alert('Failed to archive: ' + error.message);
      }
    });

    // Delete survey
    document.getElementById('delete-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to permanently delete this survey? This cannot be undone.')) return;
      if (!confirm('This will delete all questions and responses. Type "delete" to confirm.')) return;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${apiKey}` },
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete');
        }

        window.location.href = '/admin/surveys';
      } catch (error) {
        alert('Failed to delete: ' + error.message);
      }
    });
  </script>
</AdminLayout>
