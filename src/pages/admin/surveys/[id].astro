---
import AdminLayout from "../../../components/admin/AdminLayout.astro";

const apiUrl = import.meta.env.SURVEY_API_URL || "https://survey.changemanaged.io";
const apiKey = import.meta.env.SURVEY_ADMIN_API_KEY;

const { id } = Astro.params;

interface ConditionalRule {
  id: string;
  sourceQuestionId: number;
  operator: "equals" | "not_equals" | "includes" | "not_includes" | "is_answered" | "is_not_answered" | "greater_than" | "less_than";
  value?: string;
}

interface Conditional {
  match: "all" | "any";
  rules: ConditionalRule[];
}

interface Question {
  id: number;
  section_name: string | null;
  section_order: number;
  question_order: number;
  question_type: string;
  question_text: string;
  help_text: string | null;
  required: boolean;
  options: string | null;
  conditional: Conditional | string | null;
}

interface Survey {
  id: number;
  name: string;
  description: string | null;
  status: "draft" | "active" | "archived";
  created_at: string;
  updated_at: string;
  questions: Question[];
}

let survey: Survey | null = null;
let error: string | null = null;

try {
  const response = await fetch(`${apiUrl}/api/surveys/${id}`, {
    headers: { Authorization: `Bearer ${apiKey}` },
  });

  if (response.ok) {
    const data = await response.json();
    survey = data.survey;
  } else if (response.status === 404) {
    error = "Survey not found";
  } else {
    error = "Failed to load survey";
  }
} catch {
  error = "Failed to connect to API";
}

function getStatusStyle(status: string): { label: string; class: string } {
  switch (status) {
    case "active":
      return { label: "Active", class: "bg-green-100 text-green-700" };
    case "archived":
      return { label: "Archived", class: "bg-gray-100 text-gray-600" };
    default:
      return { label: "Draft", class: "bg-yellow-100 text-yellow-700" };
  }
}

export const prerender = false;
---

<AdminLayout title={survey ? `Edit: ${survey.name}` : "Survey Not Found"} currentPage="surveys">
  {error ? (
    <div class="bg-red-50 rounded-xl border border-red-200 p-6">
      <h2 class="text-lg font-medium text-red-800">{error}</h2>
      <a href="/admin/surveys" class="text-red-600 underline mt-2 inline-block">Back to surveys</a>
    </div>
  ) : survey && (
    <div class="max-w-4xl">
      <!-- Back Link -->
      <a href="/admin/surveys" class="inline-flex items-center gap-2 text-graphite hover:text-charcoal mb-6">
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Surveys
      </a>

      <!-- Survey Header -->
      <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-charcoal">Survey Details</h2>
            <span class={`text-xs px-2 py-1 rounded-full ${getStatusStyle(survey.status).class}`}>
              {getStatusStyle(survey.status).label}
            </span>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="preview-btn"
              class="inline-flex items-center gap-2 text-graphite hover:text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors text-sm"
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              Preview
            </button>
            {survey.status === "draft" && (
              <button
                id="publish-btn"
                class="inline-flex items-center gap-2 bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors text-sm"
              >
                Publish
              </button>
            )}
            {survey.status === "active" && (
              <a
                href={`/admin/surveys/${survey.id}/tokens`}
                class="inline-flex items-center gap-2 bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors text-sm"
              >
                Manage Tokens
              </a>
            )}
            {survey.status !== "archived" && (
              <button
                id="archive-btn"
                class="text-graphite hover:text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors text-sm"
              >
                Archive
              </button>
            )}
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label for="survey-name" class="block text-sm font-medium text-charcoal mb-2">Name</label>
            <input
              type="text"
              id="survey-name"
              value={survey.name}
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent font-medium"
            />
          </div>
          <div>
            <label for="survey-description" class="block text-sm font-medium text-charcoal mb-2">Description</label>
            <textarea
              id="survey-description"
              rows="2"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
            >{survey.description || ""}</textarea>
          </div>
        </div>

        <div class="flex items-center justify-between mt-4 pt-4 border-t border-stone/20">
          <span class="text-sm text-graphite">
            {survey.questions.length} questions
          </span>
          <button
            id="save-details-btn"
            class="text-deep-sage hover:text-muted-sage text-sm font-medium"
          >
            Save Changes
          </button>
        </div>
      </div>

      <!-- Questions Section -->
      <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-charcoal">Questions</h3>
          <div class="flex items-center gap-3">
            <div class="relative">
              <button
                id="template-dropdown-btn"
                class="inline-flex items-center gap-2 text-graphite hover:text-charcoal text-sm"
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
                Insert Template
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div id="template-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-stone/20 z-10">
                <button type="button" class="template-insert-btn w-full text-left px-4 py-3 hover:bg-linen text-sm" data-template="nps">
                  <span class="font-medium text-charcoal">NPS</span>
                  <span class="text-xs text-graphite block">Net Promoter Score 路 3 questions</span>
                </button>
                <button type="button" class="template-insert-btn w-full text-left px-4 py-3 hover:bg-linen text-sm border-t border-stone/10" data-template="csat">
                  <span class="font-medium text-charcoal">CSAT</span>
                  <span class="text-xs text-graphite block">Customer Satisfaction 路 6 questions</span>
                </button>
                <button type="button" class="template-insert-btn w-full text-left px-4 py-3 hover:bg-linen text-sm border-t border-stone/10" data-template="demographics">
                  <span class="font-medium text-charcoal">Demographics</span>
                  <span class="text-xs text-graphite block">Respondent profiling 路 5 questions</span>
                </button>
                <button type="button" class="template-insert-btn w-full text-left px-4 py-3 hover:bg-linen text-sm border-t border-stone/10" data-template="employee-engagement">
                  <span class="font-medium text-charcoal">Employee Engagement</span>
                  <span class="text-xs text-graphite block">Organizational health 路 12 questions</span>
                </button>
              </div>
            </div>
            <button
              id="add-question-btn"
              class="inline-flex items-center gap-2 text-deep-sage hover:text-muted-sage text-sm font-medium"
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
              </svg>
              Add Question
            </button>
          </div>
        </div>

        <div id="questions-container" class="space-y-3">
          {survey.questions.length === 0 ? (
            <p class="text-graphite text-center py-8">No questions yet. Add your first question above.</p>
          ) : (
            survey.questions.map((q, index) => {
              const opts = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];
              const cond = q.conditional ? (typeof q.conditional === 'string' ? JSON.parse(q.conditional) : q.conditional) : null;
              const hasConditions = cond && cond.rules && cond.rules.length > 0;
              return (
                <div class="question-card bg-linen rounded-lg p-4 border border-stone/20" data-id={q.id} data-index={index}>
                  <div class="flex items-start gap-4">
                    <div class="drag-handle cursor-grab text-stone hover:text-graphite mt-1">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16" />
                      </svg>
                    </div>

                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium text-deep-sage">Q{index + 1}</span>
                        <span class="text-xs bg-white text-graphite px-2 py-0.5 rounded border border-stone/20">{q.question_type}</span>
                        {q.required && <span class="text-xs text-red-500">Required</span>}
                        {hasConditions && (
                          <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded" title={`Show when ${cond.match} conditions met`}>
                            Conditional
                          </span>
                        )}
                      </div>
                      <p class="text-charcoal">{q.question_text}</p>
                      {q.help_text && <p class="text-sm text-graphite mt-1">{q.help_text}</p>}
                      {opts.length > 0 && (
                        <div class="mt-2 flex flex-wrap gap-1">
                          {opts.map((o: string) => (
                            <span class="text-xs bg-white text-graphite px-2 py-1 rounded border border-stone/20">{o}</span>
                          ))}
                        </div>
                      )}
                    </div>

                    <div class="flex items-center gap-1">
                      <button class="edit-question-btn text-graphite hover:text-deep-sage p-1" data-id={q.id} title="Edit">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      </button>
                      <button class="delete-question-btn text-graphite hover:text-red-500 p-1" data-id={q.id} title="Delete">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="bg-red-50 rounded-xl border border-red-200 p-6">
        <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
        <p class="text-sm text-red-600 mb-4">Permanently delete this survey and all its responses. This action cannot be undone.</p>
        <button
          id="delete-btn"
          class="text-red-600 hover:text-red-800 text-sm font-medium underline"
        >
          Delete Survey
        </button>
      </div>
    </div>
  )}

  <!-- Question Edit Modal -->
  <div id="question-modal" class="fixed inset-0 bg-charcoal/50 hidden items-center justify-center z-50">
    <div class="bg-cream rounded-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <h3 id="modal-title" class="text-lg font-semibold text-charcoal mb-4">Edit Question</h3>

      <form id="question-form" class="space-y-4">
        <input type="hidden" id="question-id" />

        <div>
          <label for="question-text" class="block text-sm font-medium text-charcoal mb-2">Question Text</label>
          <textarea
            id="question-text"
            rows="2"
            required
            class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
          ></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="question-type" class="block text-sm font-medium text-charcoal mb-2">Type</label>
            <select
              id="question-type"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
            >
              <option value="text">Text (short)</option>
              <option value="textarea">Text (long)</option>
              <option value="radio">Single Choice</option>
              <option value="checkbox">Multiple Choice</option>
              <option value="scale">Scale (1-5)</option>
              <option value="dropdown">Dropdown</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-charcoal mb-2">Required</label>
            <label class="flex items-center gap-2 mt-2">
              <input type="checkbox" id="question-required" class="rounded border-stone/30 text-deep-sage focus:ring-deep-sage" />
              <span class="text-sm text-graphite">Mark as required</span>
            </label>
          </div>
        </div>

        <div>
          <label for="question-help" class="block text-sm font-medium text-charcoal mb-2">Help Text (optional)</label>
          <input
            type="text"
            id="question-help"
            class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
            placeholder="Additional context for respondents"
          />
        </div>

        <div id="options-container" class="hidden">
          <label class="block text-sm font-medium text-charcoal mb-2">Options (one per line)</label>
          <textarea
            id="question-options"
            rows="4"
            class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none font-mono text-sm"
            placeholder="Option 1&#10;Option 2&#10;Option 3"
          ></textarea>
        </div>

        <!-- Conditional Logic Builder -->
        <div class="border-t border-stone/20 pt-4">
          <button
            type="button"
            id="toggle-conditional-btn"
            class="flex items-center gap-2 text-sm font-medium text-graphite hover:text-charcoal"
          >
            <svg id="conditional-chevron" class="w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
            Conditional Logic
            <span id="conditional-badge" class="hidden text-xs bg-deep-sage text-white px-2 py-0.5 rounded-full">Active</span>
          </button>

          <div id="conditional-builder" class="hidden mt-4 space-y-3">
            <div class="flex items-center gap-2 text-sm">
              <span class="text-graphite">Show this question when</span>
              <select
                id="conditional-match"
                class="px-2 py-1 rounded border border-stone/30 text-sm focus:ring-2 focus:ring-deep-sage focus:border-transparent"
              >
                <option value="all">all</option>
                <option value="any">any</option>
              </select>
              <span class="text-graphite">of these conditions are met:</span>
            </div>

            <div id="conditional-rules" class="space-y-2">
              <!-- Rules will be added here dynamically -->
            </div>

            <button
              type="button"
              id="add-rule-btn"
              class="inline-flex items-center gap-1 text-sm text-deep-sage hover:text-muted-sage"
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
              </svg>
              Add Condition
            </button>
          </div>
        </div>

        <div class="flex items-center justify-end gap-3 pt-4 border-t border-stone/20">
          <button
            type="button"
            id="cancel-modal-btn"
            class="px-4 py-2 text-graphite hover:text-charcoal"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors"
          >
            Save Question
          </button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline define:vars={{ apiUrl, apiKey, surveyId: id, initialQuestions: survey?.questions || [] }}>
    let questions = [...initialQuestions];
    let currentConditional = { match: 'all', rules: [] };
    let currentQuestionIndex = -1; // Index of question being edited (for filtering available questions)

    const modal = document.getElementById('question-modal');
    const modalTitle = document.getElementById('modal-title');
    const questionForm = document.getElementById('question-form');
    const questionIdInput = document.getElementById('question-id');
    const questionTextInput = document.getElementById('question-text');
    const questionTypeSelect = document.getElementById('question-type');
    const questionRequiredCheckbox = document.getElementById('question-required');
    const questionHelpInput = document.getElementById('question-help');
    const optionsContainer = document.getElementById('options-container');
    const questionOptionsTextarea = document.getElementById('question-options');

    // Conditional logic elements
    const toggleConditionalBtn = document.getElementById('toggle-conditional-btn');
    const conditionalChevron = document.getElementById('conditional-chevron');
    const conditionalBadge = document.getElementById('conditional-badge');
    const conditionalBuilder = document.getElementById('conditional-builder');
    const conditionalMatch = document.getElementById('conditional-match');
    const conditionalRulesContainer = document.getElementById('conditional-rules');
    const addRuleBtn = document.getElementById('add-rule-btn');

    // Operator labels
    const operatorLabels = {
      equals: 'equals',
      not_equals: 'does not equal',
      includes: 'contains',
      not_includes: 'does not contain',
      is_answered: 'is answered',
      is_not_answered: 'is not answered',
      greater_than: 'is greater than',
      less_than: 'is less than',
    };

    // Toggle conditional builder visibility
    toggleConditionalBtn?.addEventListener('click', () => {
      conditionalBuilder.classList.toggle('hidden');
      conditionalChevron.classList.toggle('rotate-90');
    });

    // Add a new condition rule
    addRuleBtn?.addEventListener('click', () => {
      addConditionRule();
    });

    function addConditionRule(rule = null) {
      const ruleId = rule?.id || 'r' + Date.now();
      const ruleDiv = document.createElement('div');
      ruleDiv.className = 'condition-rule flex items-center gap-2 p-2 bg-linen rounded-lg';
      ruleDiv.dataset.ruleId = ruleId;

      // Get available source questions (only questions before the current one)
      const availableQuestions = questions.filter((q, idx) => {
        if (currentQuestionIndex === -1) return true; // New question - show all
        return idx < currentQuestionIndex;
      });

      if (availableQuestions.length === 0) {
        ruleDiv.innerHTML = `
          <span class="text-sm text-graphite italic">No previous questions available for conditions</span>
        `;
        conditionalRulesContainer.appendChild(ruleDiv);
        return;
      }

      ruleDiv.innerHTML = `
        <select class="rule-source flex-shrink-0 px-2 py-1 rounded border border-stone/30 text-sm">
          <option value="">Select question...</option>
          ${availableQuestions.map(q => `
            <option value="${q.id}" ${rule?.sourceQuestionId == q.id ? 'selected' : ''}>
              Q${questions.indexOf(q) + 1}: ${q.question_text.substring(0, 30)}${q.question_text.length > 30 ? '...' : ''}
            </option>
          `).join('')}
        </select>
        <select class="rule-operator flex-shrink-0 px-2 py-1 rounded border border-stone/30 text-sm">
          ${Object.entries(operatorLabels).map(([value, label]) => `
            <option value="${value}" ${rule?.operator === value ? 'selected' : ''}>${label}</option>
          `).join('')}
        </select>
        <input
          type="text"
          class="rule-value flex-1 px-2 py-1 rounded border border-stone/30 text-sm"
          placeholder="Value"
          value="${rule?.value || ''}"
        />
        <button type="button" class="remove-rule-btn text-red-500 hover:text-red-700 p-1">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;

      // Handle operator change (show/hide value field)
      const operatorSelect = ruleDiv.querySelector('.rule-operator');
      const valueInput = ruleDiv.querySelector('.rule-value');
      operatorSelect.addEventListener('change', () => {
        const noValueOperators = ['is_answered', 'is_not_answered'];
        valueInput.classList.toggle('hidden', noValueOperators.includes(operatorSelect.value));
      });

      // Initial value field visibility
      const noValueOperators = ['is_answered', 'is_not_answered'];
      valueInput.classList.toggle('hidden', noValueOperators.includes(rule?.operator));

      // Handle remove button
      ruleDiv.querySelector('.remove-rule-btn').addEventListener('click', () => {
        ruleDiv.remove();
        updateConditionalBadge();
      });

      conditionalRulesContainer.appendChild(ruleDiv);
      updateConditionalBadge();
    }

    function updateConditionalBadge() {
      const ruleCount = conditionalRulesContainer.querySelectorAll('.condition-rule').length;
      conditionalBadge.classList.toggle('hidden', ruleCount === 0);
    }

    function collectConditionalData() {
      const rules = [];
      conditionalRulesContainer.querySelectorAll('.condition-rule').forEach(ruleDiv => {
        const sourceSelect = ruleDiv.querySelector('.rule-source');
        const operatorSelect = ruleDiv.querySelector('.rule-operator');
        const valueInput = ruleDiv.querySelector('.rule-value');

        if (sourceSelect?.value) {
          const rule = {
            id: ruleDiv.dataset.ruleId,
            sourceQuestionId: parseInt(sourceSelect.value),
            operator: operatorSelect.value,
          };

          const noValueOperators = ['is_answered', 'is_not_answered'];
          if (!noValueOperators.includes(operatorSelect.value)) {
            rule.value = valueInput.value;
          }

          rules.push(rule);
        }
      });

      if (rules.length === 0) return null;

      return {
        match: conditionalMatch.value,
        rules,
      };
    }

    function loadConditionalData(conditional) {
      // Clear existing rules
      conditionalRulesContainer.innerHTML = '';

      if (!conditional || !conditional.rules || conditional.rules.length === 0) {
        currentConditional = { match: 'all', rules: [] };
        conditionalMatch.value = 'all';
        conditionalBuilder.classList.add('hidden');
        conditionalChevron.classList.remove('rotate-90');
        updateConditionalBadge();
        return;
      }

      const cond = typeof conditional === 'string' ? JSON.parse(conditional) : conditional;
      currentConditional = cond;
      conditionalMatch.value = cond.match || 'all';

      cond.rules.forEach(rule => {
        addConditionRule(rule);
      });

      // Show the builder if there are rules
      conditionalBuilder.classList.remove('hidden');
      conditionalChevron.classList.add('rotate-90');
      updateConditionalBadge();
    }

    function resetConditionalBuilder() {
      conditionalRulesContainer.innerHTML = '';
      conditionalMatch.value = 'all';
      conditionalBuilder.classList.add('hidden');
      conditionalChevron.classList.remove('rotate-90');
      updateConditionalBadge();
    }

    // Templates data
    const templates = {
      nps: {
        questions: [
          { section_name: "Net Promoter Score", question_type: "scale", question_text: "How likely are you to recommend us to a friend or colleague?", help_text: "0 = Not at all likely, 10 = Extremely likely", required: true, options: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"] },
          { section_name: "Net Promoter Score", question_type: "textarea", question_text: "What is the primary reason for your score?", help_text: "Your feedback helps us improve", required: false },
          { section_name: "Net Promoter Score", question_type: "textarea", question_text: "What could we do to improve your experience?", required: false }
        ]
      },
      csat: {
        questions: [
          { section_name: "Overall Satisfaction", question_type: "scale", question_text: "How satisfied are you with our product/service?", help_text: "1 = Very dissatisfied, 5 = Very satisfied", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Overall Satisfaction", question_type: "radio", question_text: "How well did our product/service meet your expectations?", required: true, options: ["Exceeded expectations", "Met expectations", "Below expectations", "Far below expectations"] },
          { section_name: "Specific Areas", question_type: "scale", question_text: "How would you rate the quality of our product/service?", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Specific Areas", question_type: "scale", question_text: "How would you rate our customer support?", required: false, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Feedback", question_type: "textarea", question_text: "What did you like most about your experience?", required: false },
          { section_name: "Feedback", question_type: "textarea", question_text: "What could we improve?", required: false }
        ]
      },
      demographics: {
        questions: [
          { section_name: "Demographics", question_type: "dropdown", question_text: "What is your age range?", required: false, options: ["Under 18", "18-24", "25-34", "35-44", "45-54", "55-64", "65+"] },
          { section_name: "Demographics", question_type: "dropdown", question_text: "What is your gender?", required: false, options: ["Male", "Female", "Non-binary", "Prefer not to say"] },
          { section_name: "Demographics", question_type: "dropdown", question_text: "What is your current employment status?", required: false, options: ["Employed full-time", "Employed part-time", "Self-employed", "Unemployed", "Student", "Retired", "Other"] },
          { section_name: "Demographics", question_type: "dropdown", question_text: "What is your highest level of education?", required: false, options: ["High school or equivalent", "Some college", "Associate degree", "Bachelor's degree", "Master's degree", "Doctoral degree", "Professional degree"] },
          { section_name: "Demographics", question_type: "dropdown", question_text: "What is your annual household income?", required: false, options: ["Under $25,000", "$25,000 - $49,999", "$50,000 - $74,999", "$75,000 - $99,999", "$100,000 - $149,999", "$150,000 - $199,999", "$200,000+"] }
        ]
      },
      "employee-engagement": {
        questions: [
          { section_name: "Job Satisfaction", question_type: "scale", question_text: "I am satisfied with my job overall", help_text: "1 = Strongly Disagree, 5 = Strongly Agree", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Job Satisfaction", question_type: "scale", question_text: "I feel my work is meaningful and contributes to the organization", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Job Satisfaction", question_type: "scale", question_text: "I have the resources and tools I need to do my job effectively", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Leadership & Management", question_type: "scale", question_text: "My manager provides clear direction and expectations", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Leadership & Management", question_type: "scale", question_text: "I receive regular feedback on my performance", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Leadership & Management", question_type: "scale", question_text: "Leadership communicates a clear vision for the future", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Growth & Development", question_type: "scale", question_text: "I have opportunities to learn and grow in my role", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Growth & Development", question_type: "scale", question_text: "I see a clear path for career advancement", required: false, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Team & Culture", question_type: "scale", question_text: "I feel valued and respected by my colleagues", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Team & Culture", question_type: "scale", question_text: "There is good collaboration within my team", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Open Feedback", question_type: "textarea", question_text: "What do you value most about working here?", required: false },
          { section_name: "Open Feedback", question_type: "textarea", question_text: "What one thing would you change to improve your experience?", required: false }
        ]
      }
    };

    // Template dropdown toggle
    const templateDropdownBtn = document.getElementById('template-dropdown-btn');
    const templateDropdown = document.getElementById('template-dropdown');

    templateDropdownBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      templateDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', () => {
      templateDropdown?.classList.add('hidden');
    });

    // Template insert handlers
    document.querySelectorAll('.template-insert-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const templateId = btn.dataset.template;
        const template = templates[templateId];
        if (!template) return;

        if (!confirm(`Add ${template.questions.length} questions from this template?`)) return;

        templateDropdown.classList.add('hidden');

        try {
          const response = await fetch(`${apiUrl}/api/surveys/${surveyId}/questions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({ questions: template.questions }),
          });

          if (!response.ok) throw new Error('Failed to add template questions');

          window.location.reload();
        } catch (error) {
          alert('Failed to add template: ' + error.message);
        }
      });
    });

    // Show/hide options based on type
    questionTypeSelect?.addEventListener('change', () => {
      const needsOptions = ['radio', 'checkbox', 'dropdown', 'scale'].includes(questionTypeSelect.value);
      optionsContainer.classList.toggle('hidden', !needsOptions);
    });

    // Open modal for new question
    document.getElementById('add-question-btn')?.addEventListener('click', () => {
      modalTitle.textContent = 'Add Question';
      questionIdInput.value = '';
      questionTextInput.value = '';
      questionTypeSelect.value = 'text';
      questionRequiredCheckbox.checked = false;
      questionHelpInput.value = '';
      questionOptionsTextarea.value = '';
      optionsContainer.classList.add('hidden');
      currentQuestionIndex = questions.length; // New question will be at the end
      resetConditionalBuilder();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });

    // Open modal for edit
    document.querySelectorAll('.edit-question-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const qIndex = questions.findIndex(q => q.id == id);
        const q = questions[qIndex];
        if (!q) return;

        modalTitle.textContent = 'Edit Question';
        questionIdInput.value = q.id;
        questionTextInput.value = q.question_text;
        questionTypeSelect.value = q.question_type;
        questionRequiredCheckbox.checked = q.required;
        questionHelpInput.value = q.help_text || '';

        const opts = q.options ? (typeof q.options === 'string' ? JSON.parse(q.options) : q.options) : [];
        questionOptionsTextarea.value = opts.join('\n');

        const needsOptions = ['radio', 'checkbox', 'dropdown', 'scale'].includes(q.question_type);
        optionsContainer.classList.toggle('hidden', !needsOptions);

        // Load conditional data
        currentQuestionIndex = qIndex;
        loadConditionalData(q.conditional);

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      });
    });

    // Close modal
    document.getElementById('cancel-modal-btn')?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });

    // Save question
    questionForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const questionData = {
        question_text: questionTextInput.value,
        question_type: questionTypeSelect.value,
        required: questionRequiredCheckbox.checked,
        help_text: questionHelpInput.value || null,
        options: ['radio', 'checkbox', 'dropdown', 'scale'].includes(questionTypeSelect.value)
          ? questionOptionsTextarea.value.split('\n').filter(o => o.trim())
          : null,
        conditional: collectConditionalData(),
      };

      try {
        const editingQuestionId = questionIdInput.value;

        if (editingQuestionId) {
          // Editing existing question - update all questions with modified one
          const updatedQuestions = questions.map(q => {
            if (q.id == editingQuestionId) {
              return {
                ...q,
                ...questionData,
                id: q.id, // Preserve ID for reference (will be regenerated on save)
              };
            }
            return q;
          });

          const response = await fetch(`${apiUrl}/api/surveys/${surveyId}/questions`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({ questions: updatedQuestions }),
          });

          if (!response.ok) throw new Error('Failed to update question');
        } else {
          // Adding new question
          const response = await fetch(`${apiUrl}/api/surveys/${surveyId}/questions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({ questions: [questionData] }),
          });

          if (!response.ok) throw new Error('Failed to save question');
        }

        // Reload page to show updated questions
        window.location.reload();
      } catch (error) {
        alert('Failed to save question: ' + error.message);
      }
    });

    // Delete question
    document.querySelectorAll('.delete-question-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this question?')) return;

        const id = btn.dataset.id;
        try {
          const response = await fetch(`${apiUrl}/api/surveys/${surveyId}/questions?questionId=${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${apiKey}` },
          });

          if (!response.ok) throw new Error('Failed to delete');
          window.location.reload();
        } catch (error) {
          alert('Failed to delete question');
        }
      });
    });

    // Save survey details
    document.getElementById('save-details-btn')?.addEventListener('click', async () => {
      const name = document.getElementById('survey-name').value;
      const description = document.getElementById('survey-description').value;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ name, description }),
        });

        if (!response.ok) throw new Error('Failed to save');
        alert('Saved!');
      } catch (error) {
        alert('Failed to save: ' + error.message);
      }
    });

    // Publish
    document.getElementById('publish-btn')?.addEventListener('click', async () => {
      if (!confirm('Publish this survey? It will become available to respondents.')) return;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ status: 'active' }),
        });

        if (!response.ok) throw new Error('Failed to publish');
        window.location.reload();
      } catch (error) {
        alert('Failed to publish: ' + error.message);
      }
    });

    // Archive
    document.getElementById('archive-btn')?.addEventListener('click', async () => {
      if (!confirm('Archive this survey? It will no longer accept responses.')) return;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({ status: 'archived' }),
        });

        if (!response.ok) throw new Error('Failed to archive');
        window.location.reload();
      } catch (error) {
        alert('Failed to archive: ' + error.message);
      }
    });

    // Delete survey
    document.getElementById('delete-btn')?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to permanently delete this survey? This cannot be undone.')) return;
      if (!confirm('This will delete all questions and responses. Type "delete" to confirm.')) return;

      try {
        const response = await fetch(`${apiUrl}/api/surveys/${surveyId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${apiKey}` },
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete');
        }

        window.location.href = '/admin/surveys';
      } catch (error) {
        alert('Failed to delete: ' + error.message);
      }
    });

    // Preview survey
    const previewModal = document.getElementById('preview-modal');
    const previewIframe = document.getElementById('preview-iframe');

    document.getElementById('preview-btn')?.addEventListener('click', () => {
      // Get current survey data from the form
      const surveyData = {
        name: document.getElementById('survey-name').value,
        description: document.getElementById('survey-description').value,
      };

      previewModal.classList.remove('hidden');
      previewModal.classList.add('flex');

      // Load preview page in iframe
      previewIframe.src = `${apiUrl}/survey/preview?preview=true`;

      // Wait for iframe to load then send data
      previewIframe.onload = () => {
        previewIframe.contentWindow.postMessage({
          type: 'preview-survey',
          survey: surveyData,
          questions: questions,
        }, '*');
      };
    });

    document.getElementById('close-preview-btn')?.addEventListener('click', () => {
      previewModal.classList.add('hidden');
      previewModal.classList.remove('flex');
      previewIframe.src = '';
    });

    previewModal?.addEventListener('click', (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add('hidden');
        previewModal.classList.remove('flex');
        previewIframe.src = '';
      }
    });
  </script>

  <!-- Preview Modal -->
  <div id="preview-modal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-4xl h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-stone/20">
        <h3 class="text-lg font-semibold text-charcoal">Survey Preview</h3>
        <button id="close-preview-btn" class="text-graphite hover:text-charcoal">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex-1 overflow-hidden">
        <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
      </div>
    </div>
  </div>
</AdminLayout>
