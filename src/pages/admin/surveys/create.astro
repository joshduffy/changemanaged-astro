---
import AdminLayout from "../../../components/admin/AdminLayout.astro";

const apiUrl = import.meta.env.SURVEY_API_URL || "https://survey.changemanaged.io";
const apiKey = import.meta.env.SURVEY_ADMIN_API_KEY || "";

// Bug #4: Warn if API key not configured
const apiKeyMissing = !apiKey || apiKey === "your_admin_api_key_here";

export const prerender = false;
---

<AdminLayout title="Create Survey" currentPage="surveys">
  <div class="max-w-4xl">
    <!-- Back Link -->
    <a href="/admin/surveys" class="inline-flex items-center gap-2 text-graphite hover:text-charcoal mb-6">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Surveys
    </a>

    {apiKeyMissing && (
      <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-2 text-yellow-800">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span class="font-medium">API Key Not Configured</span>
        </div>
        <p class="text-sm text-yellow-700 mt-1">
          AI survey generation requires SURVEY_ADMIN_API_KEY in your environment variables. Templates still work.
        </p>
      </div>
    )}

    <!-- AI Generation Section -->
    <div id="generation-section" class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-deep-sage/10 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-deep-sage" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-charcoal">AI Survey Builder</h2>
          <p class="text-sm text-graphite">Describe your survey and let AI generate professional questions</p>
        </div>
      </div>

      <form id="generate-form" class="space-y-4">
        <!-- Main Prompt -->
        <div>
          <label for="prompt" class="block text-sm font-medium text-charcoal mb-2">
            What kind of survey do you want to create?
          </label>
          <textarea
            id="prompt"
            name="prompt"
            rows="3"
            required
            class="w-full px-4 py-3 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
            placeholder="e.g., Employee satisfaction survey focusing on work-life balance and career development opportunities"
          ></textarea>
        </div>

        <!-- Context Options -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="company" class="block text-sm font-medium text-charcoal mb-2">
              Organization (optional)
            </label>
            <input
              type="text"
              id="company"
              name="company"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
              placeholder="e.g., Acme Corp"
            />
          </div>
          <div>
            <label for="audience" class="block text-sm font-medium text-charcoal mb-2">
              Target Audience (optional)
            </label>
            <input
              type="text"
              id="audience"
              name="audience"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
              placeholder="e.g., All employees"
            />
          </div>
          <div>
            <label for="question_count" class="block text-sm font-medium text-charcoal mb-2">
              Number of Questions
            </label>
            <select
              id="question_count"
              name="question_count"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
            >
              <option value="10">~10 questions (quick)</option>
              <option value="15" selected>~15 questions (standard)</option>
              <option value="20">~20 questions (detailed)</option>
              <option value="25">~25 questions (comprehensive)</option>
            </select>
          </div>
        </div>

        <!-- Generate Button -->
        <div class="flex items-center gap-4">
          <button
            type="submit"
            id="generate-btn"
            class="inline-flex items-center gap-2 bg-deep-sage text-white px-6 py-3 rounded-lg hover:bg-muted-sage transition-colors font-medium"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Generate Survey
          </button>
          <span id="generate-status" class="text-sm text-graphite hidden"></span>
        </div>
      </form>
    </div>

    <!-- Quick Start Templates -->
    <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="font-semibold text-charcoal">Quick Start Templates</h3>
          <p class="text-sm text-graphite">Start with a pre-built template or add one to your generated survey</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <button type="button" class="template-btn text-left p-4 rounded-lg border border-stone/20 hover:border-deep-sage hover:bg-linen/50 transition-colors" data-template="nps">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-lg">üìä</span>
            <span class="font-medium text-charcoal">NPS</span>
          </div>
          <p class="text-xs text-graphite">Net Promoter Score with follow-up</p>
          <span class="text-xs text-deep-sage mt-2 inline-block">3 questions</span>
        </button>

        <button type="button" class="template-btn text-left p-4 rounded-lg border border-stone/20 hover:border-deep-sage hover:bg-linen/50 transition-colors" data-template="csat">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-lg">‚≠ê</span>
            <span class="font-medium text-charcoal">CSAT</span>
          </div>
          <p class="text-xs text-graphite">Customer Satisfaction survey</p>
          <span class="text-xs text-deep-sage mt-2 inline-block">6 questions</span>
        </button>

        <button type="button" class="template-btn text-left p-4 rounded-lg border border-stone/20 hover:border-deep-sage hover:bg-linen/50 transition-colors" data-template="demographics">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-lg">üë•</span>
            <span class="font-medium text-charcoal">Demographics</span>
          </div>
          <p class="text-xs text-graphite">Standard respondent profiling</p>
          <span class="text-xs text-deep-sage mt-2 inline-block">5 questions</span>
        </button>

        <button type="button" class="template-btn text-left p-4 rounded-lg border border-stone/20 hover:border-deep-sage hover:bg-linen/50 transition-colors" data-template="employee-engagement">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-lg">üè¢</span>
            <span class="font-medium text-charcoal">Engagement</span>
          </div>
          <p class="text-xs text-graphite">Employee engagement survey</p>
          <span class="text-xs text-deep-sage mt-2 inline-block">12 questions</span>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading-section" class="hidden bg-cream rounded-xl border border-stone/30 p-8 mb-6">
      <div class="flex flex-col items-center justify-center text-center">
        <div class="w-12 h-12 border-4 border-deep-sage/20 border-t-deep-sage rounded-full animate-spin mb-4"></div>
        <h3 class="text-lg font-medium text-charcoal mb-2">Generating your survey...</h3>
        <p class="text-sm text-graphite">AI is crafting professional questions based on your description</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-section" class="hidden bg-red-50 rounded-xl border border-red-200 p-6 mb-6">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h3 class="font-medium text-red-800">Generation Failed</h3>
          <p id="error-message" class="text-sm text-red-600 mt-1"></p>
          <button id="retry-btn" class="text-sm text-red-700 underline mt-2">Try again</button>
        </div>
      </div>
    </div>

    <!-- Preview Section (shown after generation) -->
    <div id="preview-section" class="hidden">
      <!-- Survey Header -->
      <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-charcoal">Survey Preview</h2>
          <span id="cost-badge" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full"></span>
        </div>

        <div class="space-y-4">
          <div>
            <label for="survey-title" class="block text-sm font-medium text-charcoal mb-2">Title</label>
            <input
              type="text"
              id="survey-title"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent font-medium"
            />
          </div>
          <div>
            <label for="survey-description" class="block text-sm font-medium text-charcoal mb-2">Description</label>
            <textarea
              id="survey-description"
              rows="2"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Questions List -->
      <div id="questions-container" class="space-y-4 mb-6">
        <!-- Questions will be inserted here -->
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-between bg-cream rounded-xl border border-stone/30 p-4">
        <div class="flex items-center gap-3">
          <button
            id="regenerate-btn"
            class="inline-flex items-center gap-2 text-graphite hover:text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Regenerate
          </button>
          <span id="question-count" class="text-sm text-graphite"></span>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="save-draft-btn"
            class="inline-flex items-center gap-2 text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors"
          >
            Save as Draft
          </button>
          <button
            id="save-publish-btn"
            class="inline-flex items-center gap-2 bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors"
          >
            Save & Publish
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Template (hidden) -->
  <template id="question-template">
    <div class="question-card bg-cream rounded-xl border border-stone/30 p-4" data-index="">
      <div class="flex items-start gap-4">
        <!-- Drag Handle -->
        <div class="drag-handle cursor-grab text-stone hover:text-graphite mt-1">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16" />
          </svg>
        </div>

        <!-- Question Content -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-2">
            <span class="question-number text-sm font-medium text-deep-sage"></span>
            <span class="question-type text-xs bg-linen text-graphite px-2 py-0.5 rounded"></span>
            <span class="question-required text-xs text-red-500 hidden">Required</span>
          </div>
          <p class="question-text text-charcoal"></p>
          <p class="question-help text-sm text-graphite mt-1 hidden"></p>
          <div class="question-options mt-2 hidden">
            <!-- Options will be inserted here -->
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-2">
          <button class="edit-btn text-graphite hover:text-deep-sage p-1" title="Edit">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <button class="delete-btn text-graphite hover:text-red-500 p-1" title="Delete">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </template>

  <script is:inline define:vars={{ apiUrl, apiKey }}>
    let generatedSurvey = null;
    let questions = [];

    // Embedded templates
    const templates = {
      nps: {
        name: "Net Promoter Score (NPS)",
        description: "Standard NPS survey with follow-up questions",
        questions: [
          {
            section_name: "Net Promoter Score",
            question_type: "scale",
            question_text: "How likely are you to recommend us to a friend or colleague?",
            help_text: "0 = Not at all likely, 10 = Extremely likely",
            required: true,
            options: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"]
          },
          {
            section_name: "Net Promoter Score",
            question_type: "textarea",
            question_text: "What is the primary reason for your score?",
            help_text: "Your feedback helps us improve",
            required: false
          },
          {
            section_name: "Net Promoter Score",
            question_type: "textarea",
            question_text: "What could we do to improve your experience?",
            required: false
          }
        ]
      },
      csat: {
        name: "Customer Satisfaction (CSAT)",
        description: "Customer satisfaction survey with detailed feedback",
        questions: [
          {
            section_name: "Overall Satisfaction",
            question_type: "scale",
            question_text: "How satisfied are you with our product/service?",
            help_text: "1 = Very dissatisfied, 5 = Very satisfied",
            required: true,
            options: ["1", "2", "3", "4", "5"]
          },
          {
            section_name: "Overall Satisfaction",
            question_type: "radio",
            question_text: "How well did our product/service meet your expectations?",
            required: true,
            options: ["Exceeded expectations", "Met expectations", "Below expectations", "Far below expectations"]
          },
          {
            section_name: "Specific Areas",
            question_type: "scale",
            question_text: "How would you rate the quality of our product/service?",
            required: true,
            options: ["1", "2", "3", "4", "5"]
          },
          {
            section_name: "Specific Areas",
            question_type: "scale",
            question_text: "How would you rate our customer support?",
            required: false,
            options: ["1", "2", "3", "4", "5"]
          },
          {
            section_name: "Feedback",
            question_type: "textarea",
            question_text: "What did you like most about your experience?",
            required: false
          },
          {
            section_name: "Feedback",
            question_type: "textarea",
            question_text: "What could we improve?",
            required: false
          }
        ]
      },
      demographics: {
        name: "Demographics",
        description: "Standard demographic questions for respondent profiling",
        questions: [
          {
            section_name: "Demographics",
            question_type: "dropdown",
            question_text: "What is your age range?",
            required: false,
            options: ["Under 18", "18-24", "25-34", "35-44", "45-54", "55-64", "65+"]
          },
          {
            section_name: "Demographics",
            question_type: "dropdown",
            question_text: "What is your gender?",
            required: false,
            options: ["Male", "Female", "Non-binary", "Prefer not to say"]
          },
          {
            section_name: "Demographics",
            question_type: "dropdown",
            question_text: "What is your current employment status?",
            required: false,
            options: ["Employed full-time", "Employed part-time", "Self-employed", "Unemployed", "Student", "Retired", "Other"]
          },
          {
            section_name: "Demographics",
            question_type: "dropdown",
            question_text: "What is your highest level of education?",
            required: false,
            options: ["High school or equivalent", "Some college", "Associate degree", "Bachelor's degree", "Master's degree", "Doctoral degree", "Professional degree"]
          },
          {
            section_name: "Demographics",
            question_type: "dropdown",
            question_text: "What is your annual household income?",
            required: false,
            options: ["Under $25,000", "$25,000 - $49,999", "$50,000 - $74,999", "$75,000 - $99,999", "$100,000 - $149,999", "$150,000 - $199,999", "$200,000+"]
          }
        ]
      },
      "employee-engagement": {
        name: "Employee Engagement",
        description: "Core employee engagement questions for organizational health",
        questions: [
          { section_name: "Job Satisfaction", question_type: "scale", question_text: "I am satisfied with my job overall", help_text: "1 = Strongly Disagree, 5 = Strongly Agree", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Job Satisfaction", question_type: "scale", question_text: "I feel my work is meaningful and contributes to the organization", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Job Satisfaction", question_type: "scale", question_text: "I have the resources and tools I need to do my job effectively", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Leadership & Management", question_type: "scale", question_text: "My manager provides clear direction and expectations", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Leadership & Management", question_type: "scale", question_text: "I receive regular feedback on my performance", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Leadership & Management", question_type: "scale", question_text: "Leadership communicates a clear vision for the future", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Growth & Development", question_type: "scale", question_text: "I have opportunities to learn and grow in my role", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Growth & Development", question_type: "scale", question_text: "I see a clear path for career advancement", required: false, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Team & Culture", question_type: "scale", question_text: "I feel valued and respected by my colleagues", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Team & Culture", question_type: "scale", question_text: "There is good collaboration within my team", required: true, options: ["1", "2", "3", "4", "5"] },
          { section_name: "Open Feedback", question_type: "textarea", question_text: "What do you value most about working here?", required: false },
          { section_name: "Open Feedback", question_type: "textarea", question_text: "What one thing would you change to improve your experience?", required: false }
        ]
      }
    };

    const elements = {
      generationSection: document.getElementById('generation-section'),
      loadingSection: document.getElementById('loading-section'),
      errorSection: document.getElementById('error-section'),
      previewSection: document.getElementById('preview-section'),
      generateForm: document.getElementById('generate-form'),
      generateBtn: document.getElementById('generate-btn'),
      generateStatus: document.getElementById('generate-status'),
      errorMessage: document.getElementById('error-message'),
      retryBtn: document.getElementById('retry-btn'),
      regenerateBtn: document.getElementById('regenerate-btn'),
      saveDraftBtn: document.getElementById('save-draft-btn'),
      savePublishBtn: document.getElementById('save-publish-btn'),
      surveyTitle: document.getElementById('survey-title'),
      surveyDescription: document.getElementById('survey-description'),
      questionsContainer: document.getElementById('questions-container'),
      questionCount: document.getElementById('question-count'),
      costBadge: document.getElementById('cost-badge'),
      questionTemplate: document.getElementById('question-template'),
    };

    function showSection(section) {
      elements.generationSection.classList.add('hidden');
      elements.loadingSection.classList.add('hidden');
      elements.errorSection.classList.add('hidden');
      elements.previewSection.classList.add('hidden');

      if (section === 'generation') {
        elements.generationSection.classList.remove('hidden');
      } else if (section === 'loading') {
        elements.loadingSection.classList.remove('hidden');
      } else if (section === 'error') {
        elements.errorSection.classList.remove('hidden');
        elements.generationSection.classList.remove('hidden');
      } else if (section === 'preview') {
        elements.generationSection.classList.remove('hidden');
        elements.previewSection.classList.remove('hidden');
      }
    }

    async function generateSurvey(formData) {
      showSection('loading');

      try {
        const response = await fetch(`${apiUrl}/api/ai?action=generate-survey`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            prompt: formData.get('prompt'),
            company: formData.get('company') || undefined,
            audience: formData.get('audience') || undefined,
            question_count: parseInt(formData.get('question_count')),
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || error.error || 'Generation failed');
        }

        const data = await response.json();

        // Bug #3: Validate response structure
        if (!data.survey || !data.db_format?.questions) {
          throw new Error('Invalid response format from API');
        }

        generatedSurvey = data.survey;
        questions = data.db_format.questions;

        // Populate preview
        elements.surveyTitle.value = data.survey.title;
        elements.surveyDescription.value = data.survey.description || '';
        // Bug #5: Null check for cost
        const cost = data.meta?.estimated_cost_usd ?? 0;
        elements.costBadge.textContent = `Cost: $${cost.toFixed(4)}`;

        renderQuestions();
        showSection('preview');

      } catch (error) {
        console.error('Generation error:', error);
        elements.errorMessage.textContent = error.message;
        showSection('error');
      }
    }

    function renderQuestions() {
      elements.questionsContainer.innerHTML = '';

      questions.forEach((q, index) => {
        const template = elements.questionTemplate.content.cloneNode(true);
        const card = template.querySelector('.question-card');

        card.dataset.index = index;
        card.querySelector('.question-number').textContent = `Q${index + 1}`;
        card.querySelector('.question-type').textContent = q.question_type;
        card.querySelector('.question-text').textContent = q.question_text;

        if (q.required) {
          card.querySelector('.question-required').classList.remove('hidden');
        }

        if (q.help_text) {
          const helpEl = card.querySelector('.question-help');
          helpEl.textContent = q.help_text;
          helpEl.classList.remove('hidden');
        }

        if (q.options && ['radio', 'checkbox', 'dropdown', 'scale'].includes(q.question_type)) {
          const optionsEl = card.querySelector('.question-options');
          // Bug #1: Safe JSON parsing
          let opts;
          try {
            opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
          } catch (e) {
            console.error('Failed to parse options:', e);
            opts = [];
          }
          optionsEl.innerHTML = opts.map(o => `<span class="inline-block text-xs bg-stone/20 text-graphite px-2 py-1 rounded mr-1 mb-1">${o}</span>`).join('');
          optionsEl.classList.remove('hidden');
        }

        // Bug #2: Delete handler using data attribute instead of closure
        card.querySelector('.delete-btn').addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.closest('.question-card').dataset.index);
          questions.splice(idx, 1);
          renderQuestions();
        });

        elements.questionsContainer.appendChild(card);
      });

      elements.questionCount.textContent = `${questions.length} questions`;
    }

    async function saveSurvey(status) {
      const btn = status === 'active' ? elements.savePublishBtn : elements.saveDraftBtn;
      const originalText = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      // Bug #9: Disable all interactive elements during save
      const disableAll = (disabled) => {
        elements.saveDraftBtn.disabled = disabled;
        elements.savePublishBtn.disabled = disabled;
        elements.regenerateBtn.disabled = disabled;
        elements.generateBtn.disabled = disabled;
        document.querySelectorAll('.template-btn').forEach(b => b.disabled = disabled);
      };
      disableAll(true);

      try {
        const response = await fetch(`${apiUrl}/api/surveys`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            name: elements.surveyTitle.value,
            description: elements.surveyDescription.value || null,
            questions: questions,
          }),
        });

        if (!response.ok) {
          throw new Error('Failed to save survey');
        }

        const data = await response.json();

        // Bug #6: Error handling for publish status update
        if (status === 'active') {
          const publishResponse = await fetch(`${apiUrl}/api/surveys/${data.survey.id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({ status: 'active' }),
          });

          if (!publishResponse.ok) {
            throw new Error('Survey saved but failed to publish. Check the surveys list.');
          }
        }

        // Redirect to survey list or edit page
        window.location.href = `/admin/surveys/${data.survey.id}`;

      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save survey: ' + error.message);
        // Bug #8: Reset all button states
        btn.textContent = originalText;
        disableAll(false);
      }
    }

    // Event listeners
    elements.generateForm.addEventListener('submit', (e) => {
      e.preventDefault();
      generateSurvey(new FormData(e.target));
    });

    elements.retryBtn.addEventListener('click', () => {
      showSection('generation');
    });

    elements.regenerateBtn.addEventListener('click', () => {
      generateSurvey(new FormData(elements.generateForm));
    });

    elements.saveDraftBtn.addEventListener('click', () => saveSurvey('draft'));
    elements.savePublishBtn.addEventListener('click', () => saveSurvey('active'));

    // Template handlers
    document.querySelectorAll('.template-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const templateId = btn.dataset.template;
        const template = templates[templateId];
        if (!template) return;

        if (questions.length > 0) {
          // Append to existing questions
          if (confirm(`Add ${template.questions.length} questions from "${template.name}" to your survey?`)) {
            questions = [...questions, ...template.questions];
            renderQuestions();
          }
        } else {
          // Start new survey with template
          questions = [...template.questions];
          elements.surveyTitle.value = template.name;
          elements.surveyDescription.value = template.description;
          elements.costBadge.textContent = 'Template';
          renderQuestions();
          showSection('preview');
        }
      });
    });
  </script>
</AdminLayout>
