---
import AdminLayout from "../../../components/admin/AdminLayout.astro";

const apiUrl = import.meta.env.SURVEY_API_URL || "https://survey.changemanaged.io";
const apiKey = import.meta.env.SURVEY_ADMIN_API_KEY;

export const prerender = false;
---

<AdminLayout title="Create Survey" currentPage="surveys">
  <div class="max-w-4xl">
    <!-- Back Link -->
    <a href="/admin/surveys" class="inline-flex items-center gap-2 text-graphite hover:text-charcoal mb-6">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Surveys
    </a>

    <!-- AI Generation Section -->
    <div id="generation-section" class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 bg-deep-sage/10 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-deep-sage" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
        </div>
        <div>
          <h2 class="text-lg font-semibold text-charcoal">AI Survey Builder</h2>
          <p class="text-sm text-graphite">Describe your survey and let AI generate professional questions</p>
        </div>
      </div>

      <form id="generate-form" class="space-y-4">
        <!-- Main Prompt -->
        <div>
          <label for="prompt" class="block text-sm font-medium text-charcoal mb-2">
            What kind of survey do you want to create?
          </label>
          <textarea
            id="prompt"
            name="prompt"
            rows="3"
            required
            class="w-full px-4 py-3 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
            placeholder="e.g., Employee satisfaction survey focusing on work-life balance and career development opportunities"
          ></textarea>
        </div>

        <!-- Context Options -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="company" class="block text-sm font-medium text-charcoal mb-2">
              Organization (optional)
            </label>
            <input
              type="text"
              id="company"
              name="company"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
              placeholder="e.g., Acme Corp"
            />
          </div>
          <div>
            <label for="audience" class="block text-sm font-medium text-charcoal mb-2">
              Target Audience (optional)
            </label>
            <input
              type="text"
              id="audience"
              name="audience"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
              placeholder="e.g., All employees"
            />
          </div>
          <div>
            <label for="question_count" class="block text-sm font-medium text-charcoal mb-2">
              Number of Questions
            </label>
            <select
              id="question_count"
              name="question_count"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent"
            >
              <option value="10">~10 questions (quick)</option>
              <option value="15" selected>~15 questions (standard)</option>
              <option value="20">~20 questions (detailed)</option>
              <option value="25">~25 questions (comprehensive)</option>
            </select>
          </div>
        </div>

        <!-- Generate Button -->
        <div class="flex items-center gap-4">
          <button
            type="submit"
            id="generate-btn"
            class="inline-flex items-center gap-2 bg-deep-sage text-white px-6 py-3 rounded-lg hover:bg-muted-sage transition-colors font-medium"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Generate Survey
          </button>
          <span id="generate-status" class="text-sm text-graphite hidden"></span>
        </div>
      </form>
    </div>

    <!-- Loading State -->
    <div id="loading-section" class="hidden bg-cream rounded-xl border border-stone/30 p-8 mb-6">
      <div class="flex flex-col items-center justify-center text-center">
        <div class="w-12 h-12 border-4 border-deep-sage/20 border-t-deep-sage rounded-full animate-spin mb-4"></div>
        <h3 class="text-lg font-medium text-charcoal mb-2">Generating your survey...</h3>
        <p class="text-sm text-graphite">DeepSeek R1 is crafting professional questions based on your description</p>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-section" class="hidden bg-red-50 rounded-xl border border-red-200 p-6 mb-6">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <h3 class="font-medium text-red-800">Generation Failed</h3>
          <p id="error-message" class="text-sm text-red-600 mt-1"></p>
          <button id="retry-btn" class="text-sm text-red-700 underline mt-2">Try again</button>
        </div>
      </div>
    </div>

    <!-- Preview Section (shown after generation) -->
    <div id="preview-section" class="hidden">
      <!-- Survey Header -->
      <div class="bg-cream rounded-xl border border-stone/30 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-charcoal">Survey Preview</h2>
          <span id="cost-badge" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full"></span>
        </div>

        <div class="space-y-4">
          <div>
            <label for="survey-title" class="block text-sm font-medium text-charcoal mb-2">Title</label>
            <input
              type="text"
              id="survey-title"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent font-medium"
            />
          </div>
          <div>
            <label for="survey-description" class="block text-sm font-medium text-charcoal mb-2">Description</label>
            <textarea
              id="survey-description"
              rows="2"
              class="w-full px-4 py-2 rounded-lg border border-stone/30 focus:ring-2 focus:ring-deep-sage focus:border-transparent resize-none"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Questions List -->
      <div id="questions-container" class="space-y-4 mb-6">
        <!-- Questions will be inserted here -->
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-between bg-cream rounded-xl border border-stone/30 p-4">
        <div class="flex items-center gap-3">
          <button
            id="regenerate-btn"
            class="inline-flex items-center gap-2 text-graphite hover:text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Regenerate
          </button>
          <span id="question-count" class="text-sm text-graphite"></span>
        </div>
        <div class="flex items-center gap-3">
          <button
            id="save-draft-btn"
            class="inline-flex items-center gap-2 text-charcoal px-4 py-2 rounded-lg border border-stone/30 hover:bg-linen transition-colors"
          >
            Save as Draft
          </button>
          <button
            id="save-publish-btn"
            class="inline-flex items-center gap-2 bg-deep-sage text-white px-4 py-2 rounded-lg hover:bg-muted-sage transition-colors"
          >
            Save & Publish
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Template (hidden) -->
  <template id="question-template">
    <div class="question-card bg-cream rounded-xl border border-stone/30 p-4" data-index="">
      <div class="flex items-start gap-4">
        <!-- Drag Handle -->
        <div class="drag-handle cursor-grab text-stone hover:text-graphite mt-1">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16" />
          </svg>
        </div>

        <!-- Question Content -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-2">
            <span class="question-number text-sm font-medium text-deep-sage"></span>
            <span class="question-type text-xs bg-linen text-graphite px-2 py-0.5 rounded"></span>
            <span class="question-required text-xs text-red-500 hidden">Required</span>
          </div>
          <p class="question-text text-charcoal"></p>
          <p class="question-help text-sm text-graphite mt-1 hidden"></p>
          <div class="question-options mt-2 hidden">
            <!-- Options will be inserted here -->
          </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-2">
          <button class="edit-btn text-graphite hover:text-deep-sage p-1" title="Edit">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <button class="delete-btn text-graphite hover:text-red-500 p-1" title="Delete">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </template>

  <script is:inline define:vars={{ apiUrl, apiKey }}>
    let generatedSurvey = null;
    let questions = [];

    const elements = {
      generationSection: document.getElementById('generation-section'),
      loadingSection: document.getElementById('loading-section'),
      errorSection: document.getElementById('error-section'),
      previewSection: document.getElementById('preview-section'),
      generateForm: document.getElementById('generate-form'),
      generateBtn: document.getElementById('generate-btn'),
      generateStatus: document.getElementById('generate-status'),
      errorMessage: document.getElementById('error-message'),
      retryBtn: document.getElementById('retry-btn'),
      regenerateBtn: document.getElementById('regenerate-btn'),
      saveDraftBtn: document.getElementById('save-draft-btn'),
      savePublishBtn: document.getElementById('save-publish-btn'),
      surveyTitle: document.getElementById('survey-title'),
      surveyDescription: document.getElementById('survey-description'),
      questionsContainer: document.getElementById('questions-container'),
      questionCount: document.getElementById('question-count'),
      costBadge: document.getElementById('cost-badge'),
      questionTemplate: document.getElementById('question-template'),
    };

    function showSection(section) {
      elements.generationSection.classList.add('hidden');
      elements.loadingSection.classList.add('hidden');
      elements.errorSection.classList.add('hidden');
      elements.previewSection.classList.add('hidden');

      if (section === 'generation') {
        elements.generationSection.classList.remove('hidden');
      } else if (section === 'loading') {
        elements.loadingSection.classList.remove('hidden');
      } else if (section === 'error') {
        elements.errorSection.classList.remove('hidden');
        elements.generationSection.classList.remove('hidden');
      } else if (section === 'preview') {
        elements.generationSection.classList.remove('hidden');
        elements.previewSection.classList.remove('hidden');
      }
    }

    async function generateSurvey(formData) {
      showSection('loading');

      try {
        const response = await fetch(`${apiUrl}/api/ai?action=generate-survey`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            prompt: formData.get('prompt'),
            company: formData.get('company') || undefined,
            audience: formData.get('audience') || undefined,
            question_count: parseInt(formData.get('question_count')),
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || error.error || 'Generation failed');
        }

        const data = await response.json();
        generatedSurvey = data.survey;
        questions = data.db_format.questions;

        // Populate preview
        elements.surveyTitle.value = data.survey.title;
        elements.surveyDescription.value = data.survey.description || '';
        elements.costBadge.textContent = `Cost: $${data.meta.estimated_cost_usd.toFixed(4)}`;

        renderQuestions();
        showSection('preview');

      } catch (error) {
        console.error('Generation error:', error);
        elements.errorMessage.textContent = error.message;
        showSection('error');
      }
    }

    function renderQuestions() {
      elements.questionsContainer.innerHTML = '';

      questions.forEach((q, index) => {
        const template = elements.questionTemplate.content.cloneNode(true);
        const card = template.querySelector('.question-card');

        card.dataset.index = index;
        card.querySelector('.question-number').textContent = `Q${index + 1}`;
        card.querySelector('.question-type').textContent = q.question_type;
        card.querySelector('.question-text').textContent = q.question_text;

        if (q.required) {
          card.querySelector('.question-required').classList.remove('hidden');
        }

        if (q.help_text) {
          const helpEl = card.querySelector('.question-help');
          helpEl.textContent = q.help_text;
          helpEl.classList.remove('hidden');
        }

        if (q.options && ['radio', 'checkbox', 'dropdown', 'scale'].includes(q.question_type)) {
          const optionsEl = card.querySelector('.question-options');
          const opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
          optionsEl.innerHTML = opts.map(o => `<span class="inline-block text-xs bg-stone/20 text-graphite px-2 py-1 rounded mr-1 mb-1">${o}</span>`).join('');
          optionsEl.classList.remove('hidden');
        }

        // Delete handler
        card.querySelector('.delete-btn').addEventListener('click', () => {
          questions.splice(index, 1);
          renderQuestions();
        });

        elements.questionsContainer.appendChild(card);
      });

      elements.questionCount.textContent = `${questions.length} questions`;
    }

    async function saveSurvey(status) {
      const btn = status === 'active' ? elements.savePublishBtn : elements.saveDraftBtn;
      const originalText = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;

      try {
        const response = await fetch(`${apiUrl}/api/surveys`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            name: elements.surveyTitle.value,
            description: elements.surveyDescription.value || null,
            questions: questions,
          }),
        });

        if (!response.ok) {
          throw new Error('Failed to save survey');
        }

        const data = await response.json();

        // If publishing, update status
        if (status === 'active') {
          await fetch(`${apiUrl}/api/surveys/${data.survey.id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`,
            },
            body: JSON.stringify({ status: 'active' }),
          });
        }

        // Redirect to survey list or edit page
        window.location.href = `/admin/surveys/${data.survey.id}`;

      } catch (error) {
        console.error('Save error:', error);
        alert('Failed to save survey: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Event listeners
    elements.generateForm.addEventListener('submit', (e) => {
      e.preventDefault();
      generateSurvey(new FormData(e.target));
    });

    elements.retryBtn.addEventListener('click', () => {
      showSection('generation');
    });

    elements.regenerateBtn.addEventListener('click', () => {
      generateSurvey(new FormData(elements.generateForm));
    });

    elements.saveDraftBtn.addEventListener('click', () => saveSurvey('draft'));
    elements.savePublishBtn.addEventListener('click', () => saveSurvey('active'));
  </script>
</AdminLayout>
