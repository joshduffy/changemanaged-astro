---
import AdminLayout from "../../../../components/admin/AdminLayout.astro";

const apiUrl = import.meta.env.SURVEY_API_URL || "https://survey.changemanaged.io";
const apiKey = import.meta.env.SURVEY_ADMIN_API_KEY;

const { id } = Astro.params;

interface Question {
  id: number;
  section: string;
  text: string;
  type: string;
  options?: string[];
}

interface Response {
  submission_id: string;
  submitted_at: string;
  answers: Record<string, string | string[]>;
}

interface ExportData {
  survey: { id: number; name: string; description: string };
  questions: Question[];
  responses: Response[];
  summary: { total_responses: number };
}

let data: ExportData | null = null;
let error: string | null = null;

try {
  const response = await fetch(`${apiUrl}/api/surveys/${id}/export`, {
    headers: { Authorization: `Bearer ${apiKey}` },
  });

  if (response.ok) {
    data = await response.json();
  } else {
    error = "Failed to load analytics data";
  }
} catch {
  error = "Failed to connect to API";
}

// Calculate analytics for each question
function calculateQuestionStats(question: Question, responses: Response[]) {
  const answers = responses.map(r => r.answers[question.id]).filter(Boolean);
  const total = answers.length;

  if (total === 0) return null;

  // For choice-based questions, count occurrences
  if (['radio', 'dropdown', 'scale', 'checkbox'].includes(question.type)) {
    const counts: Record<string, number> = {};

    answers.forEach(answer => {
      if (Array.isArray(answer)) {
        // Checkbox - multiple values
        answer.forEach(v => {
          counts[v] = (counts[v] || 0) + 1;
        });
      } else {
        counts[answer] = (counts[answer] || 0) + 1;
      }
    });

    return {
      type: question.type === 'scale' ? 'scale' : (question.type === 'checkbox' ? 'bar' : 'pie'),
      total,
      counts,
      labels: Object.keys(counts),
      values: Object.values(counts),
    };
  }

  // For text questions, just show response count
  return {
    type: 'text',
    total,
    responses: answers.slice(0, 5), // Sample of responses
  };
}

export const prerender = false;
---

<AdminLayout title={data ? `Analytics: ${data.survey.name}` : "Analytics"} currentPage="surveys">
  {error ? (
    <div class="bg-red-50 rounded-xl border border-red-200 p-6">
      <h2 class="text-lg font-medium text-red-800">{error}</h2>
      <a href="/admin/surveys" class="text-red-600 underline mt-2 inline-block">Back to surveys</a>
    </div>
  ) : data && (
    <div class="max-w-5xl">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <a href={`/admin/surveys/${id}`} class="inline-flex items-center gap-2 text-graphite hover:text-charcoal">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            Back
          </a>
          <h1 class="text-xl font-semibold text-charcoal">{data.survey.name} - Analytics</h1>
        </div>
        <div class="flex items-center gap-3">
          <a
            href={`/admin/surveys/${id}/responses`}
            class="text-sm text-deep-sage hover:text-muted-sage"
          >
            View All Responses
          </a>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-cream rounded-xl border border-stone/30 p-6">
          <p class="text-sm text-graphite mb-1">Total Responses</p>
          <p class="text-3xl font-semibold text-charcoal">{data.summary.total_responses}</p>
        </div>
        <div class="bg-cream rounded-xl border border-stone/30 p-6">
          <p class="text-sm text-graphite mb-1">Questions</p>
          <p class="text-3xl font-semibold text-charcoal">{data.questions.length}</p>
        </div>
        <div class="bg-cream rounded-xl border border-stone/30 p-6">
          <p class="text-sm text-graphite mb-1">Completion Rate</p>
          <p class="text-3xl font-semibold text-charcoal">
            {data.summary.total_responses > 0 ? '100%' : '0%'}
          </p>
        </div>
      </div>

      {data.responses.length === 0 ? (
        <div class="bg-cream rounded-xl border border-stone/30 p-12 text-center">
          <svg class="w-12 h-12 text-stone mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
          </svg>
          <h3 class="text-lg font-medium text-charcoal mb-2">No data to analyze yet</h3>
          <p class="text-graphite">Charts will appear here once you have survey responses.</p>
        </div>
      ) : (
        <div class="space-y-6">
          {data.questions.map((question, idx) => {
            const stats = calculateQuestionStats(question, data.responses);
            if (!stats) return null;

            return (
              <div class="bg-cream rounded-xl border border-stone/30 p-6">
                <div class="flex items-start justify-between mb-4">
                  <div>
                    <span class="text-sm text-deep-sage font-medium">Q{idx + 1}</span>
                    <h3 class="text-charcoal font-medium">{question.text}</h3>
                    <p class="text-sm text-graphite mt-1">{stats.total} responses</p>
                  </div>
                  <span class="text-xs bg-linen text-graphite px-2 py-1 rounded">{question.type}</span>
                </div>

                {stats.type === 'text' ? (
                  <div class="space-y-2">
                    <p class="text-sm text-graphite">Sample responses:</p>
                    {stats.responses.map((r) => (
                      <p class="text-sm text-charcoal bg-linen p-3 rounded-lg">{r}</p>
                    ))}
                    {stats.total > 5 && (
                      <p class="text-xs text-graphite">+ {stats.total - 5} more responses</p>
                    )}
                  </div>
                ) : (
                  <div class="flex items-center gap-8">
                    <div class="w-64 h-64">
                      <canvas
                        class="question-chart"
                        data-type={stats.type}
                        data-labels={JSON.stringify(stats.labels)}
                        data-values={JSON.stringify(stats.values)}
                      ></canvas>
                    </div>
                    <div class="flex-1">
                      <table class="w-full text-sm">
                        <tbody>
                          {stats.labels.map((label, i) => {
                            const count = stats.values[i];
                            const pct = ((count / stats.total) * 100).toFixed(1);
                            return (
                              <tr class="border-b border-stone/20 last:border-0">
                                <td class="py-2 text-charcoal">{label}</td>
                                <td class="py-2 text-right text-graphite">{count}</td>
                                <td class="py-2 text-right text-graphite w-16">{pct}%</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  )}

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      const charts = document.querySelectorAll('.question-chart');

      const colors = [
        '#2d5f4f', '#5a7c6f', '#a8c5b8', '#8fb3a5', '#3d7a67',
        '#1a4438', '#7a9f91', '#c5dbd2', '#4a8a79', '#6b9e8d'
      ];

      charts.forEach(canvas => {
        const type = canvas.dataset.type;
        const labels = JSON.parse(canvas.dataset.labels || '[]');
        const values = JSON.parse(canvas.dataset.values || '[]');

        const ctx = canvas.getContext('2d');

        if (type === 'pie') {
          new Chart(ctx, {
            type: 'pie',
            data: {
              labels,
              datasets: [{
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 0,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false,
                }
              }
            }
          });
        } else if (type === 'bar' || type === 'scale') {
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                data: values,
                backgroundColor: '#2d5f4f',
                borderRadius: 4,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              indexAxis: type === 'bar' ? 'y' : 'x',
              plugins: {
                legend: {
                  display: false,
                }
              },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: {
                    color: '#666',
                    font: { size: 11 }
                  }
                },
                y: {
                  grid: { color: '#e5e5e5' },
                  ticks: {
                    color: '#666',
                    font: { size: 11 },
                    stepSize: 1
                  },
                  beginAtZero: true,
                }
              }
            }
          });
        }
      });
    });
  </script>
</AdminLayout>
